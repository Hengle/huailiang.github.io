<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>球谐光照</title>
  <meta name="description"
    content="  游戏中的光照可以被简单分为两个部分，直接光和间接光。直接光中我们研究各种不同的BRDF材质，甚至BSDF，BSSSRDF等等。这些模型据有很不错的表现力，足够我们区分金属，皮肤，木头等等不同物体的着色表现。但这并不能满足我们，因为光并不是那么简单，光会被反射，会被折射，会被透射，会被吸收，所以物体的受光情况同...">

  <link rel="shortcut icon" href="/img/favicon.ico">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://huailiang.github.io/blog/2019/harmonics/">
  <link rel="alternate" type="application/rss+xml" title="Huailiang Blog"
    href="https://huailiang.github.io/feed.xml" />

</head>

<body>
  <main>
    <header class="site-header">
  <div class="container">
    <h1><a href="/">Hom<span>e</span></a></h1>

    <button type="button" class="sliding-panel-button">
      <span></span>
      <span></span>
      <span></span>
    </button>

    <nav class="navbar sliding-panel-content">
      <ul>
        
        <li><a href="/about" title="About">About</a>
        </li>
        
        <li><a href="/blog" title="Blog">Blog</a>
        </li>
        
        <!-- <li><a href="https://github.com/huailiang/archive/master.zip" title="Download">Download</a></li> -->
        <li><a href="/feed.xml" target="_blank"><i class="icon icon-feed"></i></a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="sliding-panel-fade-screen"></div>
    <script type="text/javascript" src="/js/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    processEscapes: true
  }
});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });

</script>
    <div class="container">
      <article role="article" class="post">

  <div class="card">
    <header class="post-header">
      <h1 class="post-title">球谐光照</h1>
      <p class="post-meta">Jul 4, 2019 •
        Huailiang</p>
    </header>

    <div class="post-content">
      <blockquote>
  <p>游戏中的光照可以被简单分为两个部分，直接光和间接光。直接光中我们研究各种不同的BRDF材质，甚至BSDF，BSSSRDF等等。这些模型据有很不错的表现力，足够我们区分金属，皮肤，木头等等不同物体的着色表现。但这并不能满足我们，因为光并不是那么简单，光会被反射，会被折射，会被透射，会被吸收，所以物体的受光情况同时又由这个场景的其他物体决定，这部分光照同时拥有着更加富强的表现力，被我们称作间接光。用来做这部分光照的算法也有很多，如raytracing，photonmap。这些算法很复杂也很有趣，不过这些并非我们讨论的重点。</p>
</blockquote>

<h2 id="section">球谐函数</h2>

<p>球谐光照实际上是一种对光照的简化，对于空间上的一点，受到的光照在各个方向上是不同的，也即各向异性，所以空间上一点如果要完全还原光照情况，那就需要记录周围球面上所有方向的光照。注意这里考虑的周围环境往往是复杂的情况，而不是几个简单的光源，如果是那样的话，直接用光源的光照模型求和就可以了。</p>

<p>如果环境光照可以用简单函数表示，那自然直接求点周围球面上的积分就可以了。但是通常光照不会那么简单，并且用函数表示光照也不方便，所以经常用的方法是使用环境光贴图,比如cubemap.</p>

<p>考虑一个简单场景中有个点，他周围的各个方向上的环境光照就是上面的cubemap呈现的，假如我想知道这个点各个方向的光照情况，那么就必须在cubemap对应的各个方向进行采样。对于一个大的场景来说，每个位置点的环境光都有可能不同，如果把每个点的环境光贴图储存起来，并且每次获取光照都从相应的贴图里面采样，可想而知这样的方法是非常昂贵的。</p>

<p>利用球谐函数就可以很好的解决这个问题，球谐函数的主要作用就是用简单的系数表示复杂的球面函数。球谐光照实际上就是将周围的环境光采样成几个系数，然后渲染的时候用这几个系数来对光照进行还原，这种过程可以看做是对周围环境光的简化，从而简化计算过程。</p>

<p>球谐函数的表达式定义如下：</p>

<script type="math/tex; mode=display">\int f(x) \,{\rm dx} = \sum_{l=0}^n \sum_{m={-l}}^l c_l^m y_l^m, \quad c_l^m = \int_S f(s)y_l^m(s) \,{\rm ds}</script>

<p>而 <script type="math/tex">y_l^m</script> 是一个阶数(l,m)和角度（法线n）相关的定量，称作球谐基，<script type="math/tex">c_l^m</script> 是对应球谐基方向上的系数。  其中 <script type="math/tex">y_l^m</script> 定义如下：</p>

<script type="math/tex; mode=display">% <![CDATA[
Y_l^m=
\begin{cases}
{\sqrt{2}}  K_l^mcos(m\phi)P_l^m(cos\theta)& \text{(m>0)}\\
{\sqrt{2}}  K_l^{m}sin(-m\phi)P_l^{-m}(cos\theta)& \text{(m<0)}\\
K_l^0P_l^0(cos\theta)& \text{(m=0)}
\end{cases} %]]></script>

<p>K为SH球谐函数的缩放因子，其公式表述如下：</p>

<script type="math/tex; mode=display">K_l^m = \sqrt{ \frac{2l+1}{4\pi} \frac{ (l-|m|)! }{ (l+|m|)! } }</script>

<p>其中的P为伴随勒让德多项式定义如下:</p>

<script type="math/tex; mode=display">P_l^m(x) = (-1)^m(1-x^2)^{m/2}\frac{ d^m }{ dx^m }P_l(x)</script>

<p>而勒让德多项式定义:</p>

<script type="math/tex; mode=display">P_l(x) =  \frac{(1)^m}{2^ll!} \frac{d^l}{dx^l} (x^2 - 1)^l</script>

<p>伴随勒让德多项式Pl为上面的勒让德多项式，替换之，得到：</p>

<script type="math/tex; mode=display">P_l^m(x) =  \frac{(-1)^m}{2^ll!} (1-x^2)^{m/2}\frac{ d^{l+m} }{ dx^{l+m} }(x^2 - 1)^l</script>

<p>由了上述参数化的表示之后即可以求得蒙特卡洛采样后的球面空间上的球谐函数，其可视化之后的形状一般如下图所示:</p>

<p><img src="/img/in-post/post-engine/tex19.jpg" alt="" /></p>

<p>实际上render过程中， 我们只近似取前几阶来构建球谐函数。前3阶的球谐基函数如下：</p>

<h4 id="l0">l=0:</h4>

<script type="math/tex; mode=display">Y_0^0 = \frac{1}{2}\sqrt{\frac{1}{\pi}}  \tag{m = 0}</script>

<h4 id="l1">l=1:</h4>

<script type="math/tex; mode=display">Y_1^{-1} = \sqrt{\frac{3}{4\pi}}\frac{y}{r}\ \tag{m =-1}</script>

<script type="math/tex; mode=display">Y_1^0 = \sqrt{\frac{3}{4\pi}}\frac{z}{r}\ \tag{m = 0}</script>

<script type="math/tex; mode=display">Y_1^1 = \sqrt{\frac{3}{4\pi}}\frac{x}{r}\ \tag{m = 1}</script>

<h4 id="l2">l=2:</h4>

<script type="math/tex; mode=display">Y_2^{-2} = \frac{1}{2}\sqrt{\frac{15}{\pi}}\frac{xz}{r^2}\ \tag{m =-2}</script>

<script type="math/tex; mode=display">Y_2^{-1} = \frac{1}{2}\sqrt{\frac{15}{\pi}}\frac{yz}{r^2}\ \tag{m =-1}</script>

<script type="math/tex; mode=display">Y_2^{-1} = \frac{1}{4}\sqrt{\frac{15}{\pi}}\frac{-x^2-z^2+2y^2}{r^2}\ \tag{m = 0}</script>

<script type="math/tex; mode=display">Y_2^1 = \frac{1}{2}\sqrt{\frac{15}{\pi}}\frac{xy}{r^2}\ \tag{m = 1}</script>

<script type="math/tex; mode=display">Y_2^2 = \frac{1}{4}\sqrt{\frac{15}{\pi}}\frac{x^2-z^2}{r^2}\ \tag{m = 2}</script>

<p>由于球谐基函数阶数是无限的，所以只能取前面几组基来近似，一般在光照中大都取3阶，也即9个球谐系数。对于每个球谐波，我们将其值绘制在球体表面上，然后绘制在极性中。通过改变前一个球体的半径简单地获得极坐标图。</p>

<center>
    <img src="/img/in-post/post-engine/tex20.jpg" />
</center>
<blockquote>
  <p><br /><br /></p>
</blockquote>

<p>这里面每个曲面都是用球坐标系表示的，球谐基都是定义在球坐标系上的函数，r（也就是离中心的距离）表示的就是这个球谐基在这个方向分量的重要程度。我是用类比傅里叶变换的方法来理解的，其实球谐函数本身就是拉普拉斯变换在球坐标系下的表示，这里的每个球谐基可以类比成傅里叶变换中频域的各个离散的频率，各个球谐基乘以对应的系数就可以还原出原来的球面函数。一个复杂的波形可以用简单的谐波和相应系数表示，同样的，一个复杂的球面上的函数也可以用简单的球谐基和相应的系数表示。</p>

<h2 id="section-1">采样</h2>

<p>在球面上均匀采样的映射的表达式, 并不是均匀的变化球面参数<script type="math/tex">\theta</script> 和 <script type="math/tex">\phi</script>， 或者说如果我们直接给 [公式] 赋两个标准随机变量的话：</p>

<script type="math/tex; mode=display">% <![CDATA[
\left\{
\begin{aligned}
\theta & = \xi_x \\
\phi & = \xi_y
\end{aligned}
\right. %]]></script>

<p>产生的采样不会是均匀分布在球面上的，而是在两个极点处比较密集：</p>

<p><img src="/img/in-post/post-engine/tex22.jpg" alt="" /></p>

<p>但是如果在$\theta-\phi$坐标系是均匀分布的：</p>

<p><img src="/img/in-post/post-engine/tex23.png" alt="" /></p>

<p>基于此， 我们在自己的<a href="https://github.com/huailiang/OpenGLEngine">引擎</a>中我们采用了基于正太分布的采样（中间稠密， 两边稀疏），来近似实现均匀采样。但还不是严格的球面均匀采样的。</p>

<p>若要严格的均匀采样，可以参考这篇<a href="http://corysimon.github.io/articles/uniformdistn-on-sphere/">论文</a>。 在引擎中， 我们使用了tools/sample.sh 生成SAMPLE_NUM=1000000个采样点，采样点使用正太分布的随机数，DEGREE=3 四阶(m = DEGREE+1)的球谐面来生成对应球谐基的因子。</p>

<p>使用球鞋函数还原的间接光照效果如下图所示:</p>

<center class="half">
    <img src="/img/in-post/post-engine/tex23.jpg" height="250" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src="/img/in-post/post-engine/tex25.jpg" height="250" />
</center>

<h2 id="section-2">球谐投影与重建</h2>

<p>根据蒙特卡罗尔积分:</p>

<p>假设一个原始的分布于球面空间上的函数为，其用球谐基函数表示后的形式为，可知, 而近似函数和球谐系数分别为：</p>

<script type="math/tex; mode=display">\int f(x) \,{\rm dx} = \sum_{l=0}^n \sum_{m={-l}}^l c_l^m y_l^m, \quad c_l^m = \int_S f(s)y_l^m(s) \,{\rm ds} \tag{1}</script>

<p>再来解释一下l,m两项，这里l,m对应着不同的球谐基函数，通常l被称为带，而我们定义第i个球谐基函数为第l*(l+1)+m个。将l,m索引化为i=l(l+1)+m后可得：</p>

<script type="math/tex; mode=display">f(s) = \sum_{i=0}^{n^2} c_iy_i(s), \quad c_i = \int_S f(s)y_i(s) \,{\rm ds} \tag{2}</script>

<p>其中ci的过程又被称为投影， 再对ci中的积分式用上述蒙特卡洛方法离散化后即可得</p>

<script type="math/tex; mode=display">c_i = \int_S f(s)y_i(s) \,{\rm ds} ≈ \frac{1}{N} \sum_{j=1}^{N}f(s_j)\omega(s_j)y_i(s_j)</script>

<script type="math/tex; mode=display">c_i = \frac{4\pi}{N}\sum_{j=1}^{N}f(s_j)y_i(s_j)  \tag{3}</script>

<p>有了上述[2]和[3]之后我们就可以对一个球面空间上的函数进行球谐投影并还原，这是下一步进行预处理与渲染计算的基础。下图给出了使用球谐变换对某球面函数进行投影与重建的情形。</p>

<p><img src="/img/in-post/post-engine/tex21.jpg" alt="" /></p>

<p>从图中可以看出随着变换波段的不断增大，对原始函数的投影与重建质量就越高，但相应的球谐因子也就不断增多。</p>

<p>此外，球谐变换还有一个非常重要的特性[特性1]，即两个函数的乘积在球面空间上的积分值与它们的球谐系数向量组的点积相同。</p>

<script type="math/tex; mode=display">\int_S f1(s)f2(s)ds = \vec{c1}  \cdot \vec{c2} = \sum_{i=0}^{N}\vec{c1_i} \cdot \vec{c2_i}</script>

<p>我们在glsl中重建球谐函数如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">float</span> <span class="n">basis</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    
    <span class="kt">float</span> <span class="n">x</span> <span class="o">=</span> <span class="n">normal</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">y</span> <span class="o">=</span> <span class="n">normal</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">z</span> <span class="o">=</span> <span class="n">normal</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">z</span><span class="o">*</span><span class="n">z</span><span class="p">;</span>
    
    <span class="n">basis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="mi">2</span><span class="p">.</span><span class="n">f</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="n">PI</span><span class="p">);</span>
    <span class="n">basis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="n">f</span><span class="o">*</span><span class="n">PI</span><span class="p">))</span><span class="o">*</span><span class="n">z</span><span class="p">;</span>
    <span class="n">basis</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="n">f</span><span class="o">*</span><span class="n">PI</span><span class="p">))</span><span class="o">*</span><span class="n">y</span><span class="p">;</span>
    <span class="n">basis</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="n">f</span><span class="o">*</span><span class="n">PI</span><span class="p">))</span><span class="o">*</span><span class="n">x</span><span class="p">;</span>
    <span class="n">basis</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="mi">2</span><span class="p">.</span><span class="n">f</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">15</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="n">PI</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">z</span><span class="p">;</span>
    <span class="n">basis</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="mi">2</span><span class="p">.</span><span class="n">f</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">15</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="n">PI</span><span class="p">)</span> <span class="o">*</span> <span class="n">z</span> <span class="o">*</span> <span class="n">y</span><span class="p">;</span>
    <span class="n">basis</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="mi">4</span><span class="p">.</span><span class="n">f</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">5</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="n">PI</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">-</span> <span class="n">z</span><span class="o">*</span><span class="n">z</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="p">);</span>
    <span class="n">basis</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="mi">2</span><span class="p">.</span><span class="n">f</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">15</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="n">PI</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="n">x</span><span class="p">;</span>
    <span class="n">basis</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="mi">4</span><span class="p">.</span><span class="n">f</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">15</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="n">PI</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">-</span> <span class="n">z</span><span class="o">*</span><span class="n">z</span><span class="p">);</span>
    <span class="n">basis</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="mi">4</span><span class="p">.</span><span class="n">f</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">35</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="n">f</span><span class="o">*</span><span class="n">PI</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">z2</span><span class="p">)</span><span class="o">*</span><span class="n">z</span><span class="p">;</span>
    <span class="n">basis</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="mi">2</span><span class="p">.</span><span class="n">f</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">105</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="n">PI</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">z</span><span class="o">*</span><span class="n">y</span><span class="p">;</span>
    <span class="n">basis</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="mi">4</span><span class="p">.</span><span class="n">f</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">21</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="n">f</span><span class="o">*</span><span class="n">PI</span><span class="p">))</span><span class="o">*</span><span class="n">z</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">z2</span><span class="p">);</span>
    <span class="n">basis</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="mi">4</span><span class="p">.</span><span class="n">f</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">7</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="n">PI</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">y2</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">x2</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">z2</span><span class="p">);</span>
    <span class="n">basis</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="mi">4</span><span class="p">.</span><span class="n">f</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">21</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="p">.</span><span class="n">f</span><span class="o">*</span><span class="n">PI</span><span class="p">))</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">z2</span><span class="p">);</span>
    <span class="n">basis</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="mi">4</span><span class="p">.</span><span class="n">f</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">105</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="n">PI</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">z2</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">;</span>
    <span class="n">basis</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="mi">4</span><span class="p">.</span><span class="n">f</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">35</span><span class="p">.</span><span class="n">f</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">PI</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">z2</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">;</span>
    
    <span class="kt">vec3</span> <span class="n">c</span> <span class="o">=</span> <span class="kt">vec3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">c</span> <span class="o">+=</span> <span class="n">coef</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">basis</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>
    
    <span class="n">FragColor</span> <span class="o">=</span> <span class="kt">vec4</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<p>在<a href="https://github.com/huailiang/OpenGLEngine">引擎</a>里运行的效果如下图:</p>

<p><img src="/img/in-post/post-engine/tex24.jpg" alt="" /></p>

<h2 id="unity">Unity中的球谐光照应用</h2>

<p>unity中至少在光照探头和前向渲染的大量顶点光照这两个地方上使用了球谐光照的技术。</p>

<h4 id="section-3">光照探头：</h4>
<p>unity的光照探头在烘焙的时候为每个探头点附近采样光照值，然后计算每个点的球谐函数基底系数，用于运行时对于动态物体计算当前点的烘焙时的全局光照。</p>

<p><img src="/img/in-post/post-engine/tex.jpg" alt="" /></p>

<h4 id="section-4">前向渲染中的实时的顶点光照：</h4>
<p>前向渲染中光源数量太多，会降低运行效率。unity的正向渲染严格控制了光照的运算数量，具体的规则是，最亮的那盏直线光一定是像素光，其他标记了important的光源在数量不超过settimng里面pixel count的情况下是像素光，否则是顶点光，unity对于第一盏最亮的直线光在第一个bass pass 计算，并计算阴影，然后选择4盏顶点光在也在第一个pass同时计算，对于其他的像素光每个多加一个额外的add pass，对于再剩下的那些顶点光则按照球谐光照的方式在一个bass pass计算。这里面可以认为超过了一定限制的光最后都变成了球谐光照 。可以认为只要你设置了pixel count的限制，你打再多的光也不会把性能拖垮，因为最终他们会转变为球谐光照来伪实现实时光照。这里面的球谐光照的做法可以认为是当场景光源每次变化时将重新在场景上采样一个大的球面，然后计算球谐基底系数，因为这时候采样已经完全忽略了光源的位置，所以在unity中过多的实时的位置光将失去位置信息。</p>

<h4 id="unity-1">unity中参数的表示</h4>

<p>中ShadeSH9 是选择了全部的L0-L2的三组共9个系数，而在unity的实现中每组系数需要3个参数，这样全部的sh9就需要27 各参数，unity将其封装在7个rgba的color中传到shader里，这7个rgba在unity的shade中分别用unity_SHAr unity_SHAg unity_SHAb unity_SHBr unity_SHBg unity_SHBb unity_SHC来表示<br />
而上面的SHEvalLinearL0L1 表示只用L0L1的四组基底的球谐函数，half3 SHEvalLinearL2 表示只选用L2的五组基底的球谐函数。</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c1">// SH lighting environment
</span><span class="n">half4</span> <span class="n">unity_SHAr</span><span class="p">;</span>
<span class="n">half4</span> <span class="n">unity_SHAg</span><span class="p">;</span>
<span class="n">half4</span> <span class="n">unity_SHAb</span><span class="p">;</span>
<span class="n">half4</span> <span class="n">unity_SHBr</span><span class="p">;</span>
<span class="n">half4</span> <span class="n">unity_SHBg</span><span class="p">;</span>
<span class="n">half4</span> <span class="n">unity_SHBb</span><span class="p">;</span>
<span class="n">half4</span> <span class="n">unity_SHC</span><span class="p">;</span>
</code></pre>
</div>

<p>通过unity的接口LightProbes.GetInterpolatedProbe即可以拿到场景某处的这组9<em>3的L0-L2的基底系数，他是一个结构体SphericalHarmonicsL2，访问它的3</em>9的数组可以把他封装成7个rgba的color。</p>

<h2 id="section-5">题后闲聊</h2>

<h4 id="section-6">话题一：</h4>

<p>在5月12日Unity主办的Unite Shanghai2019开发者大会上，腾讯天美工作室技术副总监郭智先生以《使命召唤手游，引擎技术升级与演化》为主题分享了《使命召唤手游》在技术方面的开发历程和经验。</p>

<p><img src="/img/in-post/post-engine/tex27.jpg" alt="" /></p>

<p>分享提到游戏中间接光用cubemamp做GI Specular，用SH probe做GI diffuse。 不过让我产生疑问的是， 既然使用了SH 球谐面了， 就没必要在去生成cubemap了。 因为使用SH函数，完全就可以还原物体周围的环境辐射图了。 而且他这个cubemap肯定不包含近景的间接光信息， 否则的话实时生成间接光就太耗了， 可能是是只有远景的间接光信息， 在一个场景里只会对应这样一个cubemap。 这完全就我自己猜测的，具体的原因只有他本人知道了。</p>

<p><img src="/img/in-post/post-engine/tex26.jpg" alt="" /></p>

<h4 id="section-7">话题二：</h4>

<p>球谐函数不仅在图形领域有着广泛的应用， 在其他领域也有颇多的应用，比如说人脸识别。为实现任意视点下三维人脸模型绘制,针对极其稀疏和分散的人脸数据,提出基于球谐函数的人脸模型表面光场构建方法。该方法首先利用球谐函数为线性组合表示表面光场对应的辐射度函数,然后使用添加稳定能量项的无约束最小二乘法,实现对人脸模型表面光场的鲁棒性拟合,最后采用仿真技术对任意视点下的人脸模型进行渲染。在极其稀疏的6个视点下的人脸图像上实验,结果验证了该方法的有效性。与插值法比较,验证了该方法更具鲁棒性。</p>

<p><img src="/img/in-post/post-engine/tex28.jpeg" alt="" /></p>

<h2 id="section-8">学习资料</h2>
<ul>
  <li><a href="http://www.yasrt.org/shlighting/">Spherical Harmonic Lighting Program</a></li>
  <li><a href="http://www.paulsprojects.net/opengl/sh/sh.html">Spherical Harmonics</a></li>
  <li><a href="https://www.researchgate.net/publication/234765403_Precomputed_radiance_transfer">Precomputed Radiance Transfer:Theory and Practice</a></li>
  <li><a href="http://docs.enthought.com/mayavi/mayavi/auto/example_spherical_harmonics.html">Spherical Harmonics Lighting</a></li>
  <li><a href="http://corysimon.github.io/articles/uniformdistn-on-sphere/">Generating uniformly distributed numbers on a sphere</a></li>
  <li><a href="http://cseweb.ucsd.edu/~viscomp/projects/ash/">Analytic Spherical Harmonic Coefficients for Polygonal Area Lights</a></li>
</ul>


    </div>


  </div>

</article>
    </div>

    <footer class="site-footer">
  <div class="container">
    <ul class="social">
  <li><a href="https://twitter.com/penghuailiang" target="_blank"><i class="icon icon-twitter"></i></a></li>
  <li><a href="https://www.zhihu.com/people/huailiangpenguin" target="_blank"><i class="icon icon-zhihu"></i></a></li>
  <li><a href="https://www.facebook.com/profile.php?id=100004290725320" target="_blank"><i class="icon icon-facebook"></i></a></li>
  <li><a href="https://weibo.com/6212299692/profile?topnav=1&wvr=6" target="_blank"><i class="icon icon-sina"></i></a></li>
  <li><a href="https://www.linkedin.com/in/penghuailiang/" target="_blank"><i class="icon icon-linkedin"></i></a></li>
  <li><a href="https://github.com/huailiang" target="_blank"><i class="icon icon-github"></i></a></li>
</ul>
    <p class="txt-medium-gray">
      <small>&copy;2019 All rights reserved. </small>
    </p>
  </div>
</footer>

    <a href="https://github.com/huailiang" target="_blank" class="github-corner"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#337ab7; color:#fff; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
    <script>
      $(document).ready(function () {
        $('.sliding-panel-button,.sliding-panel-fade-screen,.sliding-panel-close').on('click touchstart', function (e) {
          $('.sliding-panel-content,.sliding-panel-fade-screen').toggleClass('is-visible');
          e.preventDefault();
        });
      });
    </script>
  </main>
</body>

</html>